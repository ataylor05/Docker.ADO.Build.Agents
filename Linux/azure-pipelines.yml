parameters:
- name: ImageTag
  displayName: Image Tag
  type: string
  default: 1.0

trigger: none

pool: aks-linux

variables:
- name: KeyVaultName
  value: ataylor-ado-pipelines
- name: ImageName
  value: ado-linux-agent
- name: AcrName
  value: ataylorregistry

steps:
- task: AzureKeyVault@1
  displayName: 'Get Secrets from KeyVault'
  inputs:
    azureSubscription: 'AKS'
    KeyVaultName: '${{ variables.KeyVaultName }}'
    SecretsFilter: 'ado-pat'
    RunAsPreJob: false

- task: qetza.replacetokens.replacetokens-task.replacetokens@3
  displayName: 'Replace tokens in Dockerfile'
  inputs:
    rootDirectory: '$(System.DefaultWorkingDirectory)/Linux'
    targetFiles: '**/Dockerfile'

- task: CmdLine@2
  displayName: 'Build image'
  inputs:
    script: |
      docker build -t ${{ variables.AcrName }}.azurecr.io/${{ variables.ImageName }}:${{ parameters.ImageTag }} .
    workingDirectory: '$(System.DefaultWorkingDirectory)/Linux'

- task: AzureCLI@2
  displayName: 'Push image to Azure Container Registry'
  inputs:
    azureSubscription: 'AKS'
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
      az acr login -n ${{ variables.AcrName }}
      docker push ${{ variables.AcrName }}.azurecr.io/${{ variables.ImageName }}:${{ parameters.ImageTag }}
    workingDirectory: '$(System.DefaultWorkingDirectory)/Linux'
